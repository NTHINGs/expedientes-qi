<?php
/**
 * Mostrar formulario para agregar paciente a la base de datos
 *
 * [agregar-paciente]
 *
 * @package	 expedientes-qi
 * @since    1.0.0
 */
if ( ! function_exists( 'agregar_paciente_shortcode' ) ) {
	// Add the action.
	add_action( 'plugins_loaded', function() {
		// Add the shortcode.
		add_shortcode( 'agregar-paciente', 'agregar_paciente_shortcode' );
	});

	/**
	 * imprimir-expediente shortcode.
	 *
	 * @return string
	 * @since  1.0.0
	 */
	function agregar_paciente_shortcode() {
        ob_start();
        guardar_paciente();
        render_html();
        return ob_get_clean();
    }
    
    function render_html() {
        $current_user = wp_get_current_user();
        $variables = array("%CURRENT_USER%", "%REQUEST_URI%");
        $values = array($current_user->user_login, esc_url( $_SERVER['REQUEST_URI'] ));
        echo str_replace($variables, $values, file_get_contents( plugin_dir_path( __DIR__ ) . "/templates/agregar-paciente.html" ));
    }

    function guardar_paciente() {
        if ( !function_exists( 'wp_handle_upload' ) ){
            require_once( ABSPATH . 'wp-admin/includes/file.php' );
        }
    
        if ( isset( $_POST['submitted'] ) ) {
            global $wpdb;
            $fotografia = '/wp-content/plugins/expedientes-qi/default.png';
            if ($_FILES['fotografia']['size'] > 0 && $_FILES['fotografia']['error'] == 0) {
                // Se subio una foto
                $upload_overrides = array( 'test_form' => false );
                $movefile = wp_handle_upload( $_FILES['fotografia'], $upload_overrides );
                if ( $movefile && ! isset( $movefile['error'] ) ) {
                    // echo "File is valid, and was successfully uploaded.\n" . $movefile['url'];
                    // var_dump( $movefile );
                    $fotografia = parse_url($movefile['url'])['path'];
                } else {
                    /**
                     * Error generated by _wp_handle_upload()
                     * @see _wp_handle_upload() in wp-admin/includes/file.php
                     */
                    echo $movefile['error'];
                }
            } else {
                // No se subio una foto
            }

            $table_name = $wpdb->prefix . "expedientes_pacientes";
            $table_name_contactos = $wpdb->prefix . "expedientes_personas_contacto";
            $table_name_riesgos = $wpdb->prefix . "expedientes_riesgos_psicosociales";
            $table_name_psicotropicos = $wpdb->prefix . "expedientes_psicotropicos";

            // PACIENTE

            $values = array(
                'fotografia'         => $fotografia,
                'nombre'             => $_POST['nombre'],
                'fechadenacimiento'  => date('Y-m-d', strtotime($_POST['fechadenacimiento'])),
                'edad'               => $_POST['edad'],
                'escolaridad'        => $_POST['escolaridad'],
                'ocupacion'          => $_POST['ocupacion'],
                'estadocivil'        => $_POST['estadocivil'],
                'cantidadhijos'      => $_POST['cantidadhijos'],
                'domicilio'          => $_POST['domicilio'],
                'ciudaddeorigen'     => $_POST['ciudaddeorigen'],
                'telefono'           => $_POST['telefono'],
                'email'              => $_POST['email'],
                'enfermedades'       => $_POST['enfermedades'],
                'alergias'           => $_POST['alergias'],
                'responsable'        => $_POST['responsable'],
                'fecha_creacion'     => current_time( 'mysql' ),
                'fecha_modificacion' => current_time( 'mysql' )
            );

            $paciente_id = $wpdb->insert( $table_name, $values, array(
                '%s',
                '%s',
                '%s',
                '%d',
                '%s',
                '%s',
                '%s',
                '%d',
                '%s',
                '%s',
                '%s',
                '%s',
                '%s',
                '%s',
                '%s',
                '%s',
                '%s',
            ));

            // CONTACTOS

            foreach($_POST['nombrescontacto'] as $key => $value) {
                $values_contacto = array(
                    'nombre'             => $_POST['nombrescontacto'][$key], 
                    'relacion'           => $_POST['relacionescontacto'][$key],
                    'domicilio'          => $_POST['domicilioscontacto'][$key],
                    'telefono_celular'   => $_POST['celularescontacto'][$key],
                    'telefono_casa'      => $_POST['telcasacontacto'][$key],
                    'telefono_otro'      => $_POST['otrostelefonoscontacto'][$key],
                    'paciente'           => $paciente_id,
                );

                $wpdb->insert( $table_name_contactos, $values_contacto, array(
                    '%s',
                    '%s',
                    '%s',
                    '%s',
                    '%s',
                    '%s',
                    '%d',
                ));
            }

            // RIESGOS PSICOSOCIALES

            $riesgos_individuales = NULL;
            $riesgos_familiares = NULL;
            $riesgos_entorno = NULL;

            if (count($_POST['riesgos_individuales']) > 0) {
                $riesgos_individuales = implode(",", $_POST['riesgos_individuales']);
            }

            if (count($_POST['riesgos_familiares']) > 0) {
                $riesgos_familiares = implode(",", $_POST['riesgos_familiares']);
            }

            if (count($_POST['riesgos_entorno']) > 0) {
                $riesgos_entorno = implode(",", $_POST['riesgos_entorno']);
            }

            $wpdb->insert( $table_name_riesgos,
                array(
                    'individual'    => $riesgos_individuales,
                    'familiar'      => $riesgos_familiares,
                    'entorno'       => $riesgos_entorno,
                    'observaciones' => $_POST['riesgos_observaciones'] ,
                    'paciente'      => $paciente_id,
                ), 
                array(
                    '%s',
                    '%s',
                    '%s',
                    '%s',
                    '%d',
                )
            );


            echo $_POST['nombre'] . ' agregado correctamente';

            // PSICOTROPICOS
            foreach($_POST['sustancia'] as $key => $value) {
                $sustancia = $_POST['sustancia'][$key];
                if($_POST['sustancia'][$key] == 'Otro') {
                    $sustancia = $_POST['otrasustancia'][$key];
                }
                $values_psicotropicos = array(
                    'sustancia'          => $sustancia,
                    'añoprimeruso'       => $_POST['añoprimeruso'][$key],
                    'edadprimeruso'      => $_POST['edadprimeruso'][$key],
                    'usoregular'         => $_POST['usoregular'][$key],
                    'unidadespordia'     => $_POST['unidadespordia'][$key],
                    'unidad'             => $_POST['unidad'][$key],
                    'vecespordia'        => $_POST['vecespordia'][$key],
                    'periodo'            => $_POST['periodo'][$key],
                    'abstinenciamaxima'  => $_POST['abstinenciamaxima'][$key],
                    'abstinenciaactual'  => $_POST['abstinenciamaxima'][$key],
                    'viadeuso'           => $_POST['viadeuso'][$key],
                    'fechaultimoconsumo' => $_POST['fechaultimoconsumo'][$key],
                    'paciente'           => $paciente_id,
                );
                // sustancia          VARCHAR(100) NOT NULL ,
                // añoprimeruso       INT,
                // edadprimeruso      INT,
                // usoregular         VARCHAR(45),
                // unidadespordia     INT,
                // unidad             VARCHAR(45),
                // vecespordia        INT,
                // periodo            VARCHAR(45),
                // abstinenciamaxima  VARCHAR(45),
                // abstinenciaactual  VARCHAR(45),
                // viadeuso           VARCHAR(45),
                // fechaultimoconsumo DATE ,
                // paciente           INT NOT NULL ,

                $wpdb->insert( $table_name_psicotropicos, $values_psicotropicos, array(
                    '%s',
                    '%d',
                    '%d',
                    '%s',
                    '%d',
                    '%s',
                    '%d',
                    '%s',
                    '%s',
                    '%s',
                    '%s',
                    '%s',
                    '%d',
                ));
            }
        }
    }
}
